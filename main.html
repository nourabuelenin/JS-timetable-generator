<!DOCTYPE html>
<html lang="en">
  <head>
    <!--CSS HEX
        --jonquil: #F4C515ff;
        --white: #FFFFFFff;
        --celestial-blue: #2899CAff;
        --cerulean: #3E778Eff;
        --outer-space: #474947ff;
        --picton-blue: #02ACF4ff;
        --pigment-green: #319B36ff;*/

          CSS HEX 
         --night: #12110Fff;
         --aureolin: #FDF101ff;
         --jonquil: #F4C513ff;
         --sea-green: #3B9248ff;
         --picton-blue: #02ABEBff;
         --lapis-lazuli: #185B7Aff;
         --white: #FFFFFFff;-->

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!--=============== BOXICONS ===============-->
    <link
      href="https://unpkg.com/boxicons@2.1.2/css/boxicons.min.css"
      rel="stylesheet"
    />

    <!--=============== CSS ===============-->
    <link rel="stylesheet" href="assets/css/styles.css" />

    <title>PSU - Faculty of Engineering Timetable Generator</title>
    <link rel="icon" href="assets\img\logo2.png" />
    <title>Export Table to Excel</title>
    <script src="https://cdn.jsdelivr.net/npm/table2excel@1.1.2/dist/table2excel.min.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.js"
      integrity="sha512-KnRSGPI3rrfonYItBkenM6vyGmetr9uQViDSOb39QLvXt7EoqTn/g+pubMb7ZW9cNMNeXTIMr3utPLEf28JqiQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
  </head>
  <body>
    <!--==================== HEADER ====================-->
    <header class="header">
      <nav class="nav container">
        <a href="#" class="nav__logo">
          <img
            src="assets/img/logo2.png"
            alt="Port Said University Logo"
            style="width: 70px; max-width: 100%"
          />
          Port Said University <br />
          Faculty of Engineering
        </a>

        <div class="nav__menu" id="nav-menu">
          <ul class="nav__list">
            <li class="nav__item">
              <a
                href="http://eng.psu.edu.eg/language/en/?lang=en"
                target="_blank"
                class="nav__link"
                >Home</a
              >
            </li>
            <li class="nav__item">
              <a
                href="http://eng.psu.edu.eg/language/en/about/"
                target="_blank"
                class="nav__link"
                >About</a
              >
            </li>
            <li class="nav__item">
              <a
                href="http://eng.psu.edu.eg/language/en/undergraduates/courses-specifications-undergraduate/?lang=en"
                target="_blank"
                class="nav__link"
                >Course Specs.</a
              >
            </li>
          </ul>

          <div class="nav__close" id="nav-close">
            <i class="bx bx-x"></i>
          </div>
        </div>

        <!-- Toggle button -->
        <div class="nav__toggle" id="nav-toggle">
          <i class="bx bx-grid-alt"></i>
        </div>
      </nav>
    </header>

    <!--==================== MAIN ====================-->
    <main class="main">
      <!--==================== HOME ====================-->
      <section class="home">
        <div class="home__container container">
          <div class="home__data">
            <span class="home__subtitle"></span>
            <h1 class="home__title">Timetable Generator</h1>
            <p class="home__description">
              Hi! I'm here to help you Generate <br />
              the year schedule without conflict.
            </p>
            <a class="home__button" onclick="openPopup()"> Generate </a>
          </div>

          <div class="home__img">
            <img src="assets/img/ghost-img.png" alt="" />
            <div class="home__shadow"></div>
          </div>
        </div>

        <footer class="home__footer">
          <div class="main__action">
            <a class="main__scroll" href="#section1">
              <div class="main__scroll-box">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path d="M0 0h24v24H0z" fill="none"></path>
                  <path
                    d="M11.9997 13.1716L7.04996     8.22186L5.63574 9.63607L11.9997 16L18.3637 9.63607L16.9495 8.22186L11.9997 13.1716Z"
                    fill="rgba(28,28,30,1)"
                  ></path>
                </svg>
              </div>

              <span class="main__scroll-text">Scroll</span>
            </a>
          </div>
        </footer>
      </section>
    </main>

    <!--=============== SCROLLREVEAL ===============-->
    <script src="assets/js/scrollreveal.min.js"></script>

    <!--=============== MAIN JS ===============-->
    <script src="assets/js/main.js"></script>
    <nav></nav>
    <div id="popup" style="display: none">
      <a
        href="#"
        onclick="closePopup()"
        style="position: absolute; right: 9px; top: 9px"
        >‚ùå</a
      >
      <h2>Please select options from the form.</h2>
      <form id="selectionForm">
        <label for="major">Major:</label>
        <select id="major">
          <option value="">Select Major</option>
          <option value="Electrical Power Engineering">
            Electrical Power Engineering
          </option>
          <option value="Computer and Control Engineering">
            Computer and Control Engineering
          </option>
          <option value="Electronics and Communication Engineering">
            Electronics and Communication Engineering
          </option>
        </select>
        <label for="year">Year:</label>
        <select id="year">
          <option value="">Select Year</option>
          <option value="First">First</option>
          <option value="Second">Second</option>
          <option value="Third">Third</option>
          <option value="Fourth">Fourth</option>
        </select>
        <label for="semester">Semester:</label>
        <select id="semester">
          <option value="">Select Semester</option>
          <option value="First Semester">First</option>
          <option value="Second Semester">Second</option>
        </select>
        <br />
        <button href="#section1" type="submit">Submit</button>
      </form>
      <button id="clearButton">Clear Selection</button>
    </div>

    <!--=============== TABLE ===============-->
    <div
      style="
        display: flex;
        align-items: baseline;
        justify-content: space-evenly;
        margin-top: 20px;
        flex-direction: row-reverse;
      "
    >
      <div style="display: flex; flex-direction: column; align-items: flex-end">
        <div id="timetable" class="timetable">
          <h2 id="section1">
            <img
              src="assets/img/logo.png"
              alt="Port Said University Logo"
              style="width: 70px; max-width: 100%"
            />
            <br />
            <p id="userSelectionHeader">Please select options from the form.</p>
          </h2>
          <table class="containert" id="containert">
            <thead>
              <tr>
                <th>Time/Day</th>
                <th>Saturday</th>
                <th>Sunday</th>
                <th>Monday</th>
                <th>Tuesday</th>
                <th>Wednesday</th>
                <th>Thursday</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <th id="time">8:30 AM - 10:00 AM</th>
                <td class="time-slot" id="saturday-830-10"></td>
                <td class="time-slot" id="sunday-830-10"></td>
                <td class="time-slot" id="monday-830-10"></td>
                <td class="time-slot" id="tuesday-830-10"></td>
                <td class="time-slot" id="wednesday-830-10"></td>
                <td class="time-slot" id="thursday-830-10"></td>
              </tr>
              <tr>
                <th id="time">10:15 AM - 11:45 AM</th>
                <td class="time-slot" id="saturday-1015-1145"></td>
                <td class="time-slot" id="sunday-1015-1145"></td>
                <td class="time-slot" id="monday-1015-1145"></td>
                <td class="time-slot" id="tuesday-1015-1145"></td>
                <td class="time-slot" id="wednesday-1015-1145"></td>
                <td class="time-slot" id="thursday-1015-1145"></td>
              </tr>
              <tr>
                <th id="time">12:15 PM - 1:45 PM</th>
                <td class="time-slot" id="saturday-1215-145"></td>
                <td class="time-slot" id="sunday-1215-145"></td>
                <td class="time-slot" id="monday-1215-145"></td>
                <td class="slot" id="tuesday-1215-145">
                  <img src="assets/img/break-time.png" alt="Student Activity" />
                </td>
                <td class="time-slot" id="wednesday-1215-145"></td>
                <td class="time-slot" id="thursday-1215-145"></td>
              </tr>
              <tr>
                <th id="time">02:00 PM - 3:30 PM</th>
                <td class="time-slot" id="saturday-2-330"></td>
                <td class="time-slot" id="sunday-2-330"></td>
                <td class="time-slot" id="monday-2-330"></td>
                <td class="time-slot" id="tuesday-2-330"></td>
                <td class="time-slot" id="wednesday-2-330"></td>
                <td class="time-slot" id="thursday-2-330"></td>
              </tr>
              <tr>
                <th id="time">03:30 PM - 5:00 PM</th>
                <td class="time-slot" id="saturday-330-5"></td>
                <td class="time-slot" id="sunday-330-5"></td>
                <td class="time-slot" id="monday-330-5"></td>
                <td class="time-slot" id="tuesday-330-5"></td>
                <td class="time-slot" id="wednesday-330-5"></td>
                <td class="time-slot" id="thursday-330-5"></td>
              </tr>
            </tbody>
          </table>
        </div>
        <div style="display: flex; justify-content: flex-end">
          <button
            style="width: 250px; margin-inline: 5px"
            type="button"
            id="printBtn"
          >
            Print Timetable
          </button>
          <button
            style="width: 250px; margin-inline: 5px"
            type="button"
            id="exportBtn"
          >
            Export Timetable
          </button>
        </div>
      </div>
      <div>
        <form action="/api/timetable/" id="addClass" method="POST">
          <h3>Add New Course</h3>
          <label for="day">Day:</label>
          <select id="addClassDay">
            <option value="Saturday">Saturday</option>
            <option value="Sunday">Sunday</option>
            <option value="Monday">Monday</option>
            <option value="Tuesday">Tuesday</option>
            <option value="Wednesday">Wednesday</option>
            <option value="Thursday">Thursday</option>
          </select>
          <label for="time">Time Interval:</label>
          <select id="addClassTime">
            <option value="830-10">8:30 AM - 10:00 AM</option>
            <option value="1015-1145">10:15 AM - 11:45 AM</option>
            <option value="1215-145">12:15 PM - 1:45 PM</option>
            <option value="2-330">02:00 PM - 3:30 PM</option>
            <option value="330-5">03:30 PM - 5:00 PM</option>
          </select>
          <label for="courseName">Course Name:</label>
          <input type="text" id="courseName" required />
          <label for="instructorName">Instructor Name:</label>
          <input type="text" id="instructorName" />
          <label for="courseType">Course Type:</label>
          <select id="addCourseType">
            <option value="Lecture">Lecture</option>
            <option value="Practical Lab">Practical Lab</option>
          </select>
          <label for="roomNumber">Room Number:</label>
          <input type="text" id="roomNumber" />
          <button type="submit">Add Course</button>
        </form>
      </div>
      <div id="pop-up" class="pop-up">
        <form>
          <h3>Edit/Delete Course</h3>
          <label for="courseName">Course Name:</label>
          <input type="text" id="courseName" required />
          <label for="instructorName">Instructor Name:</label>
          <input type="text" id="instructorName" />
          <label for="courseType">Course Type:</label>
          <select id="addCourseType">
            <option value="Lecture">Lecture</option>
            <option value="Practical Lab">Practical Lab</option>
          </select>
          <label for="roomNumber">Room Number:</label>
          <input type="text" id="roomNumber" />
          <button type="submit" id="editButton">Edit Course</button>
          <button id="deleteButton">Delete Course</button>
        </form>
      </div>
    </div>

    <script>
      function openPopup() {
        document.getElementById("popup").style.display = "block";
      }

      function closePopup() {
        event.preventDefault();
        // Hide the form using its ID
        document.getElementById("popup").style.display = "none";
      }
      const selectionForm = document.getElementById("selectionForm");
      const userSelectionHeader = document.getElementById(
        "userSelectionHeader"
      );

      selectionForm.addEventListener("submit", (event) => {
        event.preventDefault();

        const major = document.getElementById("major").value;
        const year = document.getElementById("year").value;
        const semester = document.getElementById("semester").value;

        if (!major || !year || !semester) {
          userSelectionHeader.textContent =
            "Please select options from all fields.";
        } else {
          userSelectionHeader.textContent = `Major - ${major}, Year - ${year}, Semester - ${semester}`;
          document.getElementById("popup").style.display = "none";
        }
      });

      const timeSlots = document.querySelectorAll(".time-slot");
      const form = document.getElementById("addClass");

      form.addEventListener("submit", (event) => {
        event.preventDefault();

        const major = document.getElementById("major").value;
        const year = document.getElementById("year").value;
        const semester = document.getElementById("semester").value;
        const day = document.getElementById("addClassDay").value;
        const time = document.getElementById("addClassTime").value;
        const courseName = document.getElementById("courseName").value;
        const instructorName = document.getElementById("instructorName").value;
        const courseType = document.getElementById("addCourseType").value;
        const roomNumber = document.getElementById("roomNumber").value;
        if (
          !day ||
          !time ||
          !courseName ||
          !instructorName ||
          !courseType ||
          !roomNumber
        ) {
          alert("Please fill out all fields");
          return;
        }

        const timeSlotElement = document.getElementById(
          day.toLowerCase() + "-" + time
        );

        if (day.toLowerCase() === "tuesday" && time === "1215-145") {
          alert("Student Activity Time!");
          return; // Prevent further execution
        }

        if (timeSlotElement && timeSlotElement.textContent.trim()) {
          alert(
            "Selected time slot is already occupied. Please choose another day or time interval."
          );
          return; // Prevent further execution
        }

        if (timeSlotElement && !timeSlotElement.classList.contains("slot")) {
          const timeSlotElementContent = `
                <p>${courseName}</p>
                <p>${instructorName ? `Instructor: ${instructorName}` : ""}</p>
                <p>${courseType}</p>
                <p>${roomNumber ? `Room: ${roomNumber}` : ""}</p>
              `;
          timeSlotElement.innerHTML = timeSlotElementContent;
        } else {
          console.warn(
            "Selected time slot is already occupied. Please choose another."
          );
        }
        fetch("http://localhost:3000/api/timetable/", {
          method: "POST",
          body: JSON.stringify({
            major,
            year,
            semester,
            day,
            time,
            courseName,
            roomNumber,
            courseType,
            instructorName,
          }),
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.message === "Course Added Successfully!") {
              alert("Course Added Successfully!");
            } else {
              alert(
                "Selected time slot is already occupied. Please choose another!"
              );
            }
          })
          .catch((error) => console.error(error));
      });

      const popUpElement = document.getElementById("pop-up");

      timeSlots.forEach((slot) => {
        slot.addEventListener("click", (event) => {
          const courseName = slot.querySelector("p:first-child").textContent;
          console.log("Course Name:", courseName);

          const instructorName = slot
            .querySelector("p:nth-child(2)")
            ?.textContent?.split(" ")[1];
          console.log("Instructor Name:", instructorName);

          const courseType = slot.querySelector("p:nth-child(3)").textContent;
          console.log("Course Type:", courseType);

          const roomNumber = slot
            .querySelector("p:nth-child(4)")
            ?.textContent?.split(":")[1];
          console.log("Room Number:", roomNumber);

          const courseNameInput = document.getElementById("courseName");
          const instructorNameInput = document.getElementById("instructorName");
          const addCourseTypeInput = document.getElementById("addCourseType");
          const roomNumberInput = document.getElementById("roomNumber");

          courseNameInput.value = courseName;
          instructorNameInput.value = instructorName;
          addCourseTypeInput.value = courseType;
          roomNumberInput.value = roomNumber;

          const originalColor = slot.style.backgroundColor;
          popUpElement.style.display = "block";

          const editButton = document.getElementById("editButton");

          editButton.addEventListener("click", (event) => {
            event.preventDefault();
            // Fill input fields with new data
            const courseName = document.getElementById("courseName").value;
            const instructorName =
              document.getElementById("instructorName").value;
            const courseType = document.getElementById("addCourseType").value;
            const roomNumber = document.getElementById("roomNumber").value;

            if (!courseName || !instructorName || !courseType || !roomNumber) {
              alert("Please fill out all fields");
              return;
            }
            console.log("courseName", courseName);
            console.log("instructorName", instructorName);
            console.log("courseType", courseType);
            console.log("roomNumber", roomNumber);

            popUpElement.style.display = "none";
          });

          const deleteButton = document.getElementById("deleteButton");
          deleteButton.addEventListener("click", (event) => {
            // Remove data from slot
            slot.innerHTML = "";
            slot.removeAttribute("title");
            popUpElement.style.display = "none";
          });
          const cellContent = `
            <p>${courseName}</p>
            <p>${instructorName ? `Instructor: ${courseType}` : ""}</p>
            <p>${addCourseType}</p>
            <p>${roomNumber ? `Room: ${roomNumber}` : ""}</p>`;
          // Update slot content with edited information
          slot.innerHTML = cellContent;
        });
      });

      const exportBtn = document.getElementById("exportBtn");
      const timetableEl = document.querySelector(".containert"); // Change the selector to target the table directly

      exportBtn.addEventListener("click", () => {
        const workbook = new ExcelJS.Workbook();
        const worksheet = workbook.addWorksheet("New Sheet");

        // Get table data
        const rows = timetableEl.querySelectorAll("tr"); // Select all rows directly
        const headers = Array.from(
          timetableEl.querySelectorAll("thead th")
        ).map((cell) => cell.textContent); // Select headers from the first row of the table head

        // Add headers to worksheet
        worksheet.getRow(1).values = headers;
        // Populate worksheet with data
        for (let i = 2; i <= rows.length + 1; i++) {
          const cells = rows[i - 2].querySelectorAll("td");
          worksheet.getRow(i).values = Array.from(cells).map(
            (cell) => cell.textContent
          );
        }
        // Save workbook as Excel file
        const fileName = "timetable.xlsx";
        // Use a Blob and a URL to download the file in a browser
        workbook.xlsx.writeBuffer().then((buffer) => {
          const blob = new Blob([buffer], {
            type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
          });
          const url = URL.createObjectURL(blob);
          const downloadLink = document.createElement("a");
          downloadLink.href = url;
          downloadLink.download = "timetable.xlsx";
          document.body.appendChild(downloadLink); // Append the link to the body
          downloadLink.click();
          document.body.removeChild(downloadLink); // Remove the link after clicking
          URL.revokeObjectURL(url); // Clean up the URL object
          alert("Timetable exported successfully!");
        });
      });
      const printBtn = document.getElementById("printBtn");
      printBtn.addEventListener("click", printTable);
      function printTable() {
        const table = document.getElementById("containert");
        const newWindow = window.open();
        newWindow.document.write(table.outerHTML);
        newWindow.document.close();
        newWindow.print();
        newWindow.close();
      }
    </script>
    <footer class="main__footer">
      <span>POWERED BY EL NHRR GROUP</span>
    </footer>
  </body>
</html>
